#include "basic_include.h"
#include "csi_config.h"
#include "soc.h"
#include "csi_core.h"
#include "csi_kernel.h"
#include "sys_config.h"
#include "dev/dma/hg_m2m_dma.h"
#ifdef CONFIG_SLEEP
#include "lib/common/dsleepdata.h"
#endif

#include "dev/xspi/hg_xspi_psram.h"
#include "dev/xspi/hg_xspi_flash.h"
#include "dev/adc/hgadc_v1.h"
#include "hal/adc.h"

extern int  main(void);
extern int32 dev_init(void);
extern void device_init(void);
extern int psram_auto_init(int extern_pt, enum psram_clk_alt alt, struct __ctl_clk *clk);
extern void psram_info(int isready);
void pmu_watchdog_init(void);

extern uint32_t g_intstackbase;
extern uint32_t g_top_irqstack;
extern uint32_t __heap_start;
extern uint32_t __heap_end;
extern uint32_t __psram_heap_start;
extern uint32_t __psram_heap_end;
extern struct os_workqueue main_wkq;
extern uint8_t assert_holdup;
extern uint32  psram_rsv_addr;

uint32 srampool_start  = 0;
uint32 srampool_end    = 0;
uint32 psrampool_start = 0;
uint32 psrampool_end   = 0;
uint32 __sp_save[3];


#ifndef SYS_FACTORY_PARAM_SIZE
#define SYS_FACTORY_PARAM_SIZE 1024
#endif

//生成func_code=1的参数
#define FUNCCODE1_HEAD(fun_num,size) (((size) << 8) | ((fun_num)))
#define FUN_NUM (1)             //func_code=1的参数
#define FUN_NUM_1_SIZE (2+12)   //2是保留的2byte,12分别是iocfg、eqcfg、ispcfg


#ifdef PIN_FROM_PARAM
const uint16_t __used iocfg_psram[IOCFG_SIZE / 2] = {IOCFG_SIZE};
#else
#endif

#define PARAM_HEAD(size,head)  (SYS_FACTORY_PARAM_SIZE|head<<16)

const uint16_t __used isp_param[4096 / 2] = {4096, 0};
const uint16_t __used eq_param[1024 / 2] = {1024};
const uint8_t __attribute__((aligned(4))) psram_param[4096 / 2] = {
	0x63, 0x62, 0x69, 0xAA, 0x20, 0x00, 0x00, 0x00, 0x01, 0x01, 0x02, 0x01, 0x10, 0x01, 0x11, 0x01, 
	0x20, 0x02, 0x30, 0x02, 0x31, 0x02, 0x32, 0x04, 0x33, 0x04, 0x40, 0x00, 0x41, 0x01, 0x42, 0x04, 
	0x63, 0x62, 0x69, 0xAE, 0x4C, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x45, 0xA0, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x11, 0x38, 0x62, 0x01, 0xF8, 0xD6, 0xC9, 0x14, 0xC8, 0x9C, 0xB4, 0x1A, 
	0x2F, 0x4B, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x98, 0xA9, 0x7B, 0x88, 0x9C, 0x7C, 0x67, 0x67, 
	0x60, 0x76, 0x53, 0x53, 0x15, 0x66, 0x55, 0x44, 0x66, 0x00, 0x00, 0x00, 0xF7, 0xFF, 0xFF, 0x01, 
	0x01, 0x00, 0x00, 0x00, 0x20, 0x20, 0xA0, 0xA0, 0x40, 0x40, 0xC0, 0xC0, 0xFF, 0xFF, 0x02, 0x09, 
	0xC2, 0x60, 0x02, 0x02, 0x1A, 0x00, 0xE0, 0x39, 0x00, 0x40, 0x10, 0x07, 0x38, 0x38, 0x00, 0x18, 
	0x00, 0x00, 0x00, 0x00, 0x82, 0x10, 0x00, 0x00, 0x04, 0x18, 0x04, 0x18, 0x00, 0x19, 0x00, 0x19, 
	0x00, 0x04, 0x00, 0x40, 0x00, 0x6C, 0xDC, 0x02, 0x02, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 
	0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xD0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x9A, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x08, 0x00, 0x00, 
	0x02, 0x02, 0x02, 0x0A, 0x00, 0x1C, 0x4E, 0x0E, 0x04, 0x00, 0x00, 0x00, 0x08, 0x1B, 0x1B, 0x00, 
	0x00, 0x04, 0x00, 0x00, 0x08, 0x60, 0x60, 0x00, 0x00, 0x08, 0x00, 0x00, 0x08, 0x07, 0x07, 0x00, 
	0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xD0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0B, 0x0B, 0x00, 0x00, 
	0x03, 0x03, 0x03, 0x0E, 0x00, 0xD0, 0x12, 0x13, 0x04, 0x00, 0x00, 0x00, 0x08, 0x03, 0x03, 0x00, 
	0x00, 0x04, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x08, 0x27, 0x27, 0x00, 
	0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xD0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x62, 0x69, 0xAE, 
	0x4C, 0x01, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x45, 0xA0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x11, 0x38, 0x62, 0x01, 0xF8, 0xD6, 0xC9, 0x14, 0xC8, 0x9C, 0xB4, 0x1A, 0x2F, 0x4B, 0x0A, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x87, 0x87, 0x69, 0x66, 0x9B, 0x7B, 0x66, 0x67, 0x60, 0x76, 0x63, 0x54, 
	0x14, 0x66, 0x54, 0x34, 0x55, 0x00, 0x00, 0x00, 0xF7, 0xFF, 0xFF, 0x01, 0x01, 0x00, 0x00, 0x00, 
	0x20, 0x20, 0xA0, 0xA0, 0x40, 0x40, 0xC0, 0xC0, 0xFF, 0xFF, 0x02, 0x09, 0xC2, 0x60, 0x02, 0x04, 
	0x1A, 0x00, 0xE0, 0x39, 0x00, 0x40, 0x10, 0x0F, 0x38, 0x38, 0xB0, 0x18, 0x00, 0x00, 0x00, 0x00, 
	0x83, 0x10, 0x00, 0x00, 0x04, 0x18, 0x04, 0x18, 0x00, 0x19, 0x00, 0x19, 0x00, 0x08, 0x00, 0x40, 
	0x00, 0x6C, 0xDC, 0x02, 0x02, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 
	0xFF, 0xD0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x9A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x08, 0x00, 0x00, 0x02, 0x02, 0x02, 0x0A, 
	0x00, 0x1C, 0x4E, 0x0E, 0x04, 0x00, 0x00, 0x00, 0x08, 0x3B, 0x3B, 0x00, 0x00, 0x04, 0x00, 0x00, 
	0x08, 0x60, 0x60, 0x00, 0x00, 0x08, 0x00, 0x00, 0x08, 0x07, 0x07, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 
	0xFF, 0xD0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0B, 0x0B, 0x00, 0x00, 0x03, 0x03, 0x03, 0x0E, 
	0x00, 0xD0, 0x12, 0x13, 0x04, 0x00, 0x00, 0x00, 0x08, 0x23, 0x23, 0x00, 0x00, 0x04, 0x00, 0x00, 
	0x08, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x08, 0x27, 0x27, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 
	0xFF, 0xD0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x62, 0x69, 0xAE, 0x4C, 0x01, 0x04, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x58, 0xA0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0D, 0x38, 0x66, 0x01, 
	0xA4, 0x98, 0x83, 0x12, 0x6A, 0xC1, 0x38, 0x2B, 0x2F, 0x4B, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x58, 0x96, 0x6B, 0xA6, 0x75, 0x59, 0x57, 0x57, 0x52, 0x57, 0x11, 0x54, 0x22, 0x34, 0x54, 0x33, 
	0x22, 0x00, 0x00, 0x00, 0xF7, 0xFF, 0xFF, 0x01, 0x01, 0x00, 0x00, 0x00, 0x20, 0x20, 0xA0, 0xA0, 
	0x40, 0x40, 0xC0, 0xC0, 0xFF, 0xFF, 0x02, 0x09, 0xC2, 0x60, 0x02, 0x08, 0x1A, 0x00, 0xE0, 0x39, 
	0x00, 0x40, 0x10, 0x0F, 0x38, 0x38, 0x90, 0x00, 0x00, 0x00, 0x00, 0x00, 0x83, 0x10, 0x00, 0x00, 
	0x04, 0x18, 0x04, 0x18, 0x00, 0x19, 0x00, 0x19, 0x00, 0x08, 0x00, 0x40, 0x00, 0x6C, 0xDC, 0x02, 
	0x02, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xD0, 0x07, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x08, 0x9A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0x00, 0x00, 0x00, 0x08, 0x08, 0x00, 0x00, 0x02, 0x02, 0x02, 0x0A, 0x00, 0x1C, 0x4E, 0x0E, 
	0x04, 0x00, 0x00, 0x00, 0x08, 0x1B, 0x1B, 0x00, 0x00, 0x04, 0x00, 0x00, 0x08, 0x60, 0x60, 0x00, 
	0x00, 0x08, 0x00, 0x00, 0x08, 0x47, 0x47, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xD0, 0x07, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0B, 0x0B, 0x00, 0x00, 0x02, 0x02, 0x02, 0x0C, 0x00, 0xD0, 0x12, 0x13, 
	0x04, 0x00, 0x00, 0x00, 0x08, 0x03, 0x03, 0x00, 0x00, 0x04, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 
	0x00, 0x08, 0x00, 0x00, 0x08, 0x67, 0x67, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xD0, 0x07, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00
};
const uint32_t __used sys_factory_param[SYS_FACTORY_PARAM_SIZE / 2] __at_section("SYS_PARAM") = {PARAM_HEAD(SYS_FACTORY_PARAM_SIZE,0x2B1A),FUNCCODE1_HEAD(FUN_NUM,FUN_NUM_1_SIZE),(uint32_t)IOCFG_PARAM_ADDR,(uint32_t)eq_param,(uint32_t)isp_param};


/** recommend usage :
  * 1、CSI (CPU separate) cache use for IBUS : SRAM(0x040000000) FLASH(0x10000000) PSRAM(0x08000000)
  *        32kB*2                       DBUS : SRAM(0x200000000) FLASH(0x30000000) PSRAM(0x28000000)
  *
  * 2、CLD (AHB share) cache only for   DBUS : PSRAM(0x28000000) can share for CPU0 & CPU1
  *        32KB
  */
__SYS_INIT void cache_open(void)
{
    sysctrl_cpu0_ibus_burst_set(CPU_BURST_SIZE_16B);

    sysctrl_cpu0_l2_dcache_en(0);
    sysctrl_cpu1_l2_dcache_en(0);
    cld_cache_disable();

    csi_cache_reset_profile();
    if (!IS_SRAM_ADDR((uint32_t) & (__Vectors))) {
        csi_cache_set_range(0, ((uint32_t) & (__Vectors)) & 0xFFF00000, CACHE_CRCR_8M, 0x1);
    }

    csi_cache_enable_profile();
    csi_dcache_enable();
}

__SYS_INIT void cache_open_psram(void)
{
    sysctrl_cpu0_dbus_burst_set(CPU_BURST_SIZE_0B);

    sysctrl_cpu0_l2_dcache_en(1);
    sysctrl_force_cld_allocate_en();
    cld_cache_invalidate_all();
    cld_cache_enable();
    cld_cache_enable_profile();

#if defined(PSRAM_HEAP)
    if (!SYSCTRL_GET_CPU0_L2_DCACHE_EN) {
        sysctrl_cpu0_dbus_burst_set(CPU_BURST_SIZE_16B);
        csi_cache_set_range(3, PSRAM_BASE, CACHE_CRCR_16M, 0x1);
    } else {
        csi_cache_set_range(3, PSRAM_BASE_I, CACHE_CRCR_16M, 0x1);
    }
#endif
}


__SYS_INIT void system_clock_init(void)
{
   if (!sysctrl_cmu_sysclk_set(DEFAULT_SYS_CLK, 1)) {
       while (1);
   }
}

__SYS_INIT void system_set_ace_peris(void)
{
    uint32_t ie = disable_irq();
#ifndef SINGLE_CORE
    sysctrl_ace_peris_access_cpu0(ACE_USB20|ACE_USB11|ACE_GMAC|ACE_DISPLAY_TOP|ACE_VIDEO_INTF_TOP|ACE_VIDEO_SUBSYS_TOP|ACE_OSPI_CTRL|ACE_QSPI_CTRL|ACE_H264_CODEC_TOP|ACE_IMAGE_ISP_TOP|ACE_VIDEO_GPU_TOP);
    sysctrl_ace_peris_access_cpu1(ACE_BASEBAND1|ACE_BASEBAND|ACE_RFDIGITAL|ACE_RFDIGCAL_TOP);
    sysctrl_ace_peris_access_cpu_all(ACE_MIX_TOP|ACE_GPIO_TOP|ACE_EFUSE_CTRL|ACE_SYS_SEC_TOP|ACE_PMU);
#else
    sysctrl_ace_peris_access_cpu0(0xFFFFFFFF);
    sysctrl_ace_peris_access_cpu_all(ACE_BASEBAND1|ACE_BASEBAND|ACE_RFDIGITAL|ACE_RFDIGCAL_TOP);
#endif
    enable_irq(ie);
}

#ifndef SINGLE_CORE
__SYS_INIT void sys_start_cpu1(uint32_t run_addr)
{
    os_printf(KERN_NOTICE"kick start cpu1 at %p!\n", run_addr);

    CoreSetting->soft_int_pending = 0;
    CoreSetting->print_level = 0;
    CoreSetting->disable_print = 0;
    CoreSetting->dcache_maint_en = CONFI_CORE_DCACHE_MAINT_EN;
    CoreSetting->dbg_uart_dev = CONFI_CORE_UARTDEV;
    CoreSetting->m2m_dma_dev = (HG_M2M_DMA_NUM > 2) ? 0 : 1; // modify HG_M2M_DMA_NUM CORE0 2 or 3 （core1 use DMA2）
    CoreSetting->adc_dev = 0;
    CoreSetting->wdt1_to = 4;
    CoreSetting->wdt1_irq_hdl = 0;
    CoreSetting->cpu_clk = CONFIG_CORE_CPU_CLK;
    CoreSetting->rxbuf_addr = CONFIG_CORE_RXBUF_ADDR;
    CoreSetting->rxbuf_size = CONFIG_CORE_RXBUF_SIZE;
    CoreSetting->heap_addr = CONFIG_CORE_HEAP_START;
    CoreSetting->heap_size = CONFIG_CORE_HEAP_SIZE;
    CoreSetting->skbpool_addr = CONFIG_CORE_SKB_POOL_ADDR;
    CoreSetting->skbpool_size = CONFIG_CORE_SKB_POOL_SIZE;
    CoreSetting->skbpool_flag = 0;
    CoreSetting->soft_int_pending = 0;
    CoreSetting->vif_maxcnt = 2;
    CoreSetting->bss_maxcnt = 16;
    CoreSetting->sta_maxcnt = 2;
    CoreSetting->bss_lifetime = 30;
    CoreSetting->heap_flag = 0;//SYSHEAP_FLAGS_MEM_LEAK_TRACE | SYSHEAP_FLAGS_MEM_OVERFLOW_CHECK;

    sysctrl_cpu1_softrst_en();
    __NOP();
    __NOP();
    __NOP();
    __NOP();
    sysctrl_cpu1_softrst_system_en();
    sysctrl_cpu1_softrst_self_dis();
    sysctrl_set_cpu1_pc_rst_addr(run_addr >> 10);
    sysctrl_cpu1_clk_en();
    sysctrl_set_cpu1_jtag_map(CPU1_JTAG_DISABLE);
    sysctrl_cpu1_softrst_dis();
    while(!CoreSetting->cpu1_ready);
    os_printf(KERN_INFO"CPU1 ready!\r\n");
}
#endif

void cld_cache_irq_handler(void *data)
{
    os_printf("%s %d\r\n",__func__, __LINE__);
    os_printf("CTRL=%08x\r\n", DCACHE_CTRL->CTRL);
    os_printf("MAINT_STATUS=%08x\r\n", DCACHE_CTRL->MAINT_STATUS);
    os_printf("SECIRQSTAT=%08x\r\n", DCACHE_CTRL->SECIRQSTAT);
    os_printf("NSECIRQSTAT=%08x\r\n", DCACHE_CTRL->NSECIRQSTAT);
     __disable_irq();
    while(1);
}


__SYS_INIT void SystemInit(void)
{
    IC_SIM_START();

    srampool_start  = (uint32)&__heap_start;
    srampool_end    = (uint32)&__heap_end;
#if defined(PSRAM_HEAP)
    psrampool_start = (uint32)&__psram_heap_start;
    psrampool_end   = (uint32)&__psram_heap_end;
#endif

    sysctrl_qspi_lock();
    
    cache_open();

    *((uint32_t *)(&g_intstackbase)) = 0xDEADBEEF;
    __set_VBR((uint32_t) & (__Vectors));

    SYSCTRL_REG_OPT_INIT();
    sys_reset_pending_clr();

    PMU_REG_CLR_BITS(PMU->PMUCON7, BIT(PMU_WDT_LOCK_SIGN)|BIT(PMU_WDT1_LOCK_SIGN)|BIT(PMU_LPWDT_LOCK_SIGN)|BIT(PMU_BOOT_DIRECT_RUN));
    sysctrl_efuse_pwron_init();

    if (sysctrl_get_softreset_pending()) {
        sysctrl_clr_softreset_pending();
        pmu_set_direct_run_pengding2();
    } else {
        pmu_clr_direct_run_pengding2();
    }

	ll_xip_clock_init(0);
    sysctrl_cmu_init();

#ifndef FPGA_SUPPORT
    system_clock_init();
#endif
    if (DEFAULT_SYS_CLK > (192*1000000) ) {
        void ll_clock_set_apb0_div(uint8 apb0_div);
        ll_clock_set_apb0_div(2);
    }

    //pmu_vdd_core_set(5);
    pmu_vdd_dis();

#if defined(CONFIG_SEPARATE_IRQ_SP)
    /* 801 not supported */
    __set_Int_SP((uint32_t)&g_top_irqstack);
    __set_CHR(__get_CHR() | CHR_ISE_Msk);
#endif

    VIC->TSPR = 0xFF;
    /* Clear active and pending IRQ */
    csi_vic_disable_all_irq();
    csi_vic_clear_all_pending_irq();
    csi_vic_clear_all_active();

    /* All peripheral interrupt priority is set to lowest */
    for (uint32 i = 0; i < IRQ_NUM; i++) {
        csi_vic_set_prio(i, 7);
    }

    csi_coret_config(system_clock_get() / CONFIG_SYSTICK_HZ, CORET_IRQn);    //1ms
    csi_vic_enable_irq(CORET_IRQn);
    request_irq(LVD_IRQn, lvd_irq_handler, 0);
    irq_enable(LVD_IRQn);

    cld_cache_irq_enable();
    request_irq(EXT_DCACHE_IRQn, cld_cache_irq_handler, 0);
    irq_enable(EXT_DCACHE_IRQn);

    pmu_clr_deadcode_pending();
}

__init static void malloc_init(void)
{
    uint32 flags = 0;
#ifdef MEM_TRACE
    flags |= SYSHEAP_FLAGS_MEM_LEAK_TRACE | SYSHEAP_FLAGS_MEM_OVERFLOW_CHECK;
#endif
    sram_heap.name = "sram";
    sram_heap.ops  = &mmpool1_ops;
    sysheap_init(&sram_heap, (void *)SYS_HEAP_START, SYS_HEAP_SIZE, flags);
}

__init static void malloc_psram_init(void)
{
#ifdef PSRAM_HEAP
    uint32 flags = SYSHEAP_FLAGS_MEM_ALIGN_32;
#ifdef MEM_TRACE
    flags |= SYSHEAP_FLAGS_MEM_LEAK_TRACE | SYSHEAP_FLAGS_MEM_OVERFLOW_CHECK;
#endif
    psram_heap.name = "psram";
    psram_heap.ops  = &mmpool1_ops;
    sysheap_init(&psram_heap, (void *)SYS_PSRAM_HEAP_START, SYS_PSRAM_HEAP_SIZE, flags);
#endif
}

__init static int system_psram_init(void)
{
	extern void add_psram_cfg();
	add_psram_cfg();
    int psram_heap_size = psram_auto_init(0, PSRAM_CLK_320M, NULL);
    cache_open_psram();

#ifdef PSRAM_HEAP
    if(psram_heap_size){
        psrampool_end = PSRAM_BASE + psram_heap_size*1024*1024;
        malloc_psram_init(); 
        psram_rsv_addr = (uint32)os_malloc_psram(32);
    }

//    psram_info(psram_heap_size);
    if(!psram_heap_size){
        os_printf("psram not ready\n");
        while(1);
    }
	return psram_heap_size;
#endif
}


__init void pre_main(void)
{
    CoreSetting->cpu1_ready = 0;
    assert_holdup = ASSERT_HOLDUP;

    save_boot_loader_addr();
	
    malloc_init();
    
    int psram_size = system_psram_init();

#ifdef CSKY_OS
    csi_kernel_init();
#endif
#ifdef OHOS
    LOS_KernelInit();
#endif

    dev_init();
    device_init();

    system_set_ace_peris();
    sysctrl_efuse_validity_handle();

#ifndef SINGLE_CORE
    adc_open((struct adc_device *)dev_get(HG_ADC0_DEVID));
    irq_enable(CPU_DBG_ON_IRQn);
    csi_vic_set_prio(CPU_DBG_ON_IRQn, 1);
    sys_start_cpu1(0x10001000);
#endif

#ifdef CONFIG_SLEEP
    sys_sleepcb_init();
    sys_sleepdata_init();
#endif
    pmu_watchdog_init();

	psram_info(psram_size);
    VERSION_SHOW();
    module_version_show();
    sys_reset_show();
    os_workqueue_init(&main_wkq, "MAIN", OS_TASK_PRIORITY_NORMAL, NULL, 2048);
    mainwkq_monitor_init();
    os_run_func((os_run_func_t)main, 0, 0, 0);

#ifdef CSKY_OS
    csi_kernel_start();
#endif
#ifdef OHOS
    LOS_Start();
#endif
}

